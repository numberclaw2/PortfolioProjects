CREATE MULTISET VOLATILE TABLE BLEND_Detail_CARE, NO LOG
AS                
(
SEL
   Td_Month_Begin(Current_Date) AS rpt_mth,
   b.mtn AS New_Act_MTN,
   a.VSN_CUST_TYPE_CD,
   a.CUST_ID,
   a.ACCT_NUM,
   a.CUST_LINE_SEQ_ID,
   b.LINE_ACT_DT,
   b.user_id,
   a.DEACT_CD,
   a.DEACT_DESC,
   a.MTN_STATUS_IND,
   a.Disc_MTN,
   a.ESN_NUM,
   a.TRIM_ESN_NUM,
   a.SIM_NUM,
   a.PROD_NM,
   a.TIER,
   a.Disc_NT_User_ID,
   a.Disc_NT_User_NM,
   a.Disc_NT_User_Dept
FROM DISCO3 AS a
INNER JOIN NEW_LINES2_CARE AS b
   ON a.CUST_ID = b.CUST_ID AND a.ACCT_NUM = b.ACCT_NUM
WHERE a.LINE_TERM_DT BETWEEN b.line_act_dt AND b.line_act_dt + INTERVAL '30' DAY
  AND a.VSN_CUST_TYPE_CD IN ('PE','ME')
QUALIFY ROW_NUMBER() OVER (PARTITION BY b.mtn ORDER BY a.LINE_TERM_DT DESC) = 1
)
WITH DATA
PRIMARY INDEX (cust_id, ACCT_NUM, CUST_LINE_SEQ_ID)
ON COMMIT PRESERVE ROWS;