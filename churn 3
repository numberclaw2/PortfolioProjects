CREATE MULTISET VOLATILE TABLE DISCO, NO Log
AS
(
SELECT DISTINCT
    a.vsn_cust_type_cd,
    c.prod_nm AS Deact_Prod_Nm,
    a.cust_id,
    a.acct_num,
    a.cust_line_seq_id,
    a.line_act_dt,
    a.line_term_dt,
    b.user_id,
    a.DEACT_CHANGE_REAS_CD AS DEACT_CD,
    e.CHANGE_REAS_DESC AS DEACT_DESC,
    a.cntrct_eff_dt,
    a.prepaid_ind,
    a.MTN_STATUS_IND,
    a.mtn,
    a.PPLAN_EFF_DT,
    a.esn_change_reas_cd,
    a.esn_change_dt,
    b.NETACE_USER_NM,
    COALESCE(a.eqp_device_id, a.esn_num) AS ESN_NUM,
    CASE 
        WHEN a.eqp_device_id IS NOT NULL THEN Substr(a.eqp_device_id, 1, 14) 
        ELSE a.ESN_NUM 
    END AS TRIM_ESN_NUM,
    CASE 
        WHEN a.prod_nm LIKE '%sim%' THEN a.esn_num 
        ELSE NULL 
    END AS SIM_NUM,
    COALESCE(a.device_prod_nm, a.prod_nm) AS PROD_NM,
    c.TIER,
    f.NT_USER_ID AS Disc_NT_User_ID,
    f.NM_FIRST || ' ' || f.NM_LAST AS Disc_NT_User_NM,
    f.DEPT_DESC AS Disc_NT_User_Dept,
    CASE 
        WHEN a.LINE_TERM_DT IS NOT NULL AND a.LINE_TERM_DT - a.LINE_ACT_DT < 31 THEN 1 
        ELSE 0 
    END AS WFG_DISCO,
    CASE 
        WHEN c.DEVICE_BRAND_NM = 'VZ INTERNET GATEWAY' THEN 1 
        ELSE 0 
    END AS FWA_IND,
    a.line_term_dt - b.LINE_ACT_DT AS DAYS_BETWEEN
FROM NTL_PRD_ALLVM.CUST_ACCT_LINE_V AS a
INNER JOIN NEW_LINES2_CARE AS b
    ON a.CUST_ID = b.CUST_ID
    AND a.cust_line_seq_id <> b.cust_line_seq_id
LEFT OUTER JOIN ntl_prd_allvm.device_dp_map_v AS c
    ON COALESCE(a.device_prod_nm, a.prod_nm) = c.prod_nm
LEFT JOIN ntl_prd_allvm.hr_employee_hist_v AS f
    ON f.emp_id = b.NETACE_USER_ID
    AND a.line_term_dt BETWEEN f.EFF_DT AND f.EXP_DT
INNER JOIN CHANGE_REASON_V AS e
    ON a.DEACT_CHANGE_REAS_CD = e.CHANGE_REAS_CD
    AND e.SOR_ID = 'v'
WHERE 
    a.MTN_STATUS_IND = 'd'
    AND a.line_term_dt BETWEEN b.line_act_dT AND b.line_act_dT + INTERVAL '30' DAY
    AND a.DEACT_CHANGE_REAS_CD NOT IN ('91', '90', '36', 'PF', '41', '35', 'TC', 'FI', 'PP') -- Exclusions
    AND (NOT(a.LINE_TERM_DT - a.LINE_ACT_DT < 31) OR a.LINE_TERM_DT IS NULL)
    AND c.DEVICE_BRAND_NM <> 'VZ INTERNET GATEWAY'
)
WITH DATA
PRIMARY INDEX (cust_id, cust_line_seq_id)
ON COMMIT PRESERVE ROWS;

CREATE MULTISET VOLATILE TABLE DISCO3, NO Log
AS
(
SELECT DISTINCT
    a.VSN_CUST_TYPE_CD,
    a.CUST_ID,
    a.ACCT_NUM,
    a.CUST_LINE_SEQ_ID,
    a.LINE_ACT_DT,
    a.LINE_TERM_DT,
    a.DEACT_CD,
    a.DEACT_DESC,
    a.MTN_STATUS_IND,
    a.MTN AS Disc_MTN,
    a.ESN_NUM,
    a.TRIM_ESN_NUM,
    a.SIM_NUM,
    a.PROD_NM,
    a.TIER,
    a.Disc_NT_User_ID,
    a.Disc_NT_User_NM,
    a.Disc_NT_User_Dept,
    CASE 
        WHEN a.CUST_ID IS NOT NULL THEN 1 
        ELSE 0 
    END AS LINES_LOST_IND,
    b.TOT_LINES_LOST
FROM DISCO AS a
INNER JOIN (
    SELECT
        line_term_dt,
        cust_id,
        acct_num,
        COUNT(DISTINCT MTN) AS TOT_LINES_LOST
    FROM DISCO
    GROUP BY 1, 2, 3
) AS b
    ON a.cust_id = b.cust_id 
    AND a.acct_num = b.acct_num 
    AND a.line_term_dt = b.line_term_dt
)
WITH DATA
PRIMARY INDEX (cust_id, cust_line_seq_id)
ON COMMIT PRESERVE ROWS;